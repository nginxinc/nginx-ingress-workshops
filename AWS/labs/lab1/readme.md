# Lab 1: AWS cli, EKS and ECR Setup guide


## What is AWS EKS?

Amazon Elastic Kubernetes Service is a service provided for Kubernetes on AWS
infrastructure. The Kubernetes resources will be fully managed by AWS, which
offloads the burden on maintaining the infrastructure, and makes sure these
resources are highly available and reliable at all times

## What is AWS ECR?

Amazon Elastic Container Registry managed container registry. Like the popular
docker registry Dockerhub, ECR also supports private and public repositories. We
can either push or pull images to ECR using AWS CLI.


## AWS Regions, Availability Zones and naming convention suggestions

1. Check out the available [AWS
   Regions](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html).
   Decide on a [Datacenter
   region](https://aws.amazon.com/about-aws/global-infrastructure/) that is
   closest to you and meets your needs. Check out the [AWS latency
   test](https://ping.psa.fun/)! We will need to choose one and input a region
   name in the following steps.
2. Consider a naming and tagging convention to organize your cloud assets to
   support user identification of shared subscriptions.

**Example:** 

I am located in Chicago, Illinois; I will opt to use the Datacenter region
`us-east-1` based in US East (Virginia). I could also use the following naming
convention:

```bash
<Asset_type>-<your_id_yourname>-<location>-<###>
```

So for my EKS Cluster I will deploy in US East (Virginia), i.e., `us-east-1 `, and
will name my Cluster `eks-shouvik-us-east-1` or just `eks-shouvik-useast1` since I
don't intend to have more than one EKS deployment

I will also use the tag `owner=shouvik` to further identify my asset on our shared
account

## AWS CLI Basic Setting(Configuration and Credential File Settings)

We will need AWS Command Line Interface (CLI) installed on your client machine to manage your AWS services. See [Installing, updating, and uninstalling the AWS
CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html)

Make sure to install AWS CLI with version 2.11.3 or higher. To check AWS CLI version run below command: 
```bash
aws --version
```

1. Configure client using `aws configure`

```bash
# Access your "My Security Credentials" section in your profile. 
# Create or Obtain your access key

aws configure

AWS Access Key ID [None]: [YOUR KEY]
AWS Secret Access Key [None]: [YOUR KEY]
Default region name [None]: us-east-1
Default output format [None]: json
```

We can inspect the files generated by the CLI using the `aws configure`  

3. Check `~/.aws/credentials` settings

```bash
cat ~/.aws/credentials

[default]
aws_access_key_id = [YOUR KEY]
aws_secret_access_key = [YOUR KEY]
```

4. Check `~/.aws/config`  setting

```bash
cat ~/.aws/config

[default]
region = us-east-1
output = json
```

Note: For file examples with multiple named profiles, see [Named
profiles](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html).


5.  Let try our first aws cli command. Get a list of all of the Regions that are
    enabled for your account:

```bash
aws ec2 describe-regions | grep RegionName
```

## Deploy a Kubernetes Cluster with AWS CLI

You can deploy a cluster using multiple ways. Check out the See [Getting started
with
`eksctl`](https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html)

 We will only cover the **EKS CLI**

1. [AWS](https://docs.aws.amazon.com/eks/latest/userguide/getting-started-console.html)
   CLI 
2. [EKS](https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html)
   CLI, `eksctl` (newer) 



### Amazon Elastic Kubernetes Service (EKS) Setup using [`eksctl`](https://eksctl.io/) 

[eksctl](https://eksctl.io/) is a simple CLI tool for creating clusters on EKS;
eksctl is now the [official command line for
EKS](https://aws.amazon.com/blogs/opensource/eksctl-eks-cli/)

Check out [Installing or upgrading eksctl](https://eksctl.io/) and review some
standard command-line options in the [eksctl
introduction](https://eksctl.io/introduction/)

### Setup Amazon EKS

1. For this demo, we will be creating an EKS cluster using the `eksctl` tool. We
   can test that our installation was successful with the following command.

   ```bash
   eksctl version
   ```

2. Use `eksctl` to create a production-ready EKS cluster with  some options in a
   single command (**This will take a while**):

   ```bash
   MY_REGION=us-east-1
   MY_EKS=eks-shouvik-useast1
   MY_NAME=shouvik

   eksctl create cluster \
      --name=$MY_EKS \
      --region=$MY_REGION \
      --nodes=3 \
      --tags owner=$MY_NAME \
      --version=1.24
   ```
   **NOTE:** At the time of this writing 1.24 is the latest kubernetes version that Amazon EKS supports.

3. To create or update the `kubeconfig` file for your cluster, run the following
   command:

   ```bash
   MY_REGION=us-east-1
   MY_EKS=eks-shouvik-useast1

   aws eks --region $MY_REGION update-kubeconfig --name $MY_EKS
   ```

4. If you are managing multiple Kubernetes clusters, you can easily change
   between context using the `kubectl config set-context` command:

   ```bash
   # Get a list of kubernetes clusters in you local kube config
   kubectl config get-clusters
   NAME
   local-k8s-cluster
   arn:aws:eks:us-east-1:664*********:cluster/eks-shouvik-useast1

   # Set context
   kubectl config set-context eks-shouvik-useast1

   # Check which context you are currently targeting
   kubectl config current-context

   # Allows you to switch between contexts using their name
   kubectl config use-context <CONTEXT_NAME>

   # Get Nodes in the target kubernetes cluster
   kubectl get nodes

   NAME                             STATUS   ROLES    AGE     VERSION
   ip-192-168-10-41.ec2.internal    Ready    <none>   6m44s   v1.24.7-eks-fb459a0
   ip-192-168-3-39.ec2.internal     Ready    <none>   6m47s   v1.24.7-eks-fb459a0
   ip-192-168-55-183.ec2.internal   Ready    <none>   6m47s   v1.24.7-eks-fb459a0
   ```

5. Make sure below cluster add-ons are of minimum required version.

   Add-ons  |  Version
   :--------:|:--------: 
   Amazon VPC CNI | 1.8.0 and later
   coreDNS | 1.8.4 and later
   kube-proxy | 1.21.2-eksbuild.2 and later

   Run below commands to check version of each of the above mentioned add-ons.
   ```bash
   kubectl describe daemonset aws-node --namespace kube-system | grep amazon-k8s-cni:

   kubectl describe deployment coredns --namespace kube-system | grep coredns:

   kubectl describe daemonset kube-proxy --namespace kube-system | grep kube-proxy:
   ```
   ``` bash
   ###Sample output###
      Image:      602401143452.dkr.ecr.us-east-1.amazonaws.com/amazon-k8s-cni:v1.11.4-eksbuild.1
   coredns:
      Image:       602401143452.dkr.ecr.us-east-1.amazonaws.com/eks/coredns:v1.8.7-eksbuild.3
   kube-proxy:
      Image:      602401143452.dkr.ecr.us-east-1.amazonaws.com/eks/kube-proxy:v1.24.7-minimal-eksbuild.2
   ```

6. Create an IAM OIDC identity provider for your cluster with `eksctl`.
    
   - Determine whether you have an existing IAM OIDC provider for your cluster. Retrieve your cluster's OIDC provider ID and store it in a variable.
      ```bash
      OIDC_ID=$(aws eks describe-cluster --name $MY_EKS --query "cluster.identity.oidc.issuer" --output text | cut -d '/' -f 5)
      ```

   - Determine whether an IAM OIDC provider with your cluster's ID is already in your account.
      ```bash
      aws iam list-open-id-connect-providers | grep $OIDC_ID | cut -d "/" -f4
      ```
      If output is returned, then you already have an IAM OIDC provider for your cluster and you can skip the next step. If no output is returned, then you must create an IAM OIDC provider for your cluster.

   - Create an IAM OIDC identity provider for your cluster with the following command. 
      ```bash
      eksctl utils associate-iam-oidc-provider --cluster $MY_EKS --approve
      ```

## Create an AWS Container Registry (ECR)

For additional registry authentication methods, including the Amazon ECR
credential helper, see [Registry
Authentication](https://docs.aws.amazon.com/AmazonECR/latest/userguide/Registries.html#registry_auth).
Also, refer to the AWS [ECR user
guide](https://docs.aws.amazon.com/AmazonECR/latest/userguide/get-set-up-for-amazon-ecr.html)
for tips and best practices for [creating the
repository](https://docs.aws.amazon.com/AmazonECR/latest/userguide/repository-create.html).



**On Shared Registry and Repositories** : The URL for your default registry is
`https://$MY_AWS_ACCOUNT_ID.dkr.ecr.$MY_REGION.amazonaws.com` , and by default,
your account has read and write access to the repositories in your default
registry. In the next step we can log the registry using the `aws ecr` command. 

On **shared corporate accounts** you will be using a **shared Container
registry** and so you should consider prepending a unique name for the a
namespace to group  the repository into a category , i.e. your own group. For
example, the repository name may be specified on its own (such as
`nginx-web-app`) or it can be prepended with a namespace to group the repository
into a category or user  (such as `shouvik/nginx-web-app`).



### [Create your ECR](#authenicate-to-ecr)

 - Retrieve an authentication token and authenticate your Docker client to your registry  using the `aws ecr` command:
   ```bash
   MY_AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
   MY_REGION=us-east-1

   aws ecr get-login-password --region $MY_REGION | docker login --username AWS --password-stdin $MY_AWS_ACCOUNT_ID.dkr.ecr.$MY_REGION.amazonaws.com
   ```

- At the end of the output you should see `Login Succeeded`!

### Test access to your ECR 

We can quickly test the ability to push images to our Private ECR from our client machine.

Take note of the image URIs in your private registry that is created from the following steps. We will need it for when we push container images to the registry.

1. Create an ECR repository for your container images

   ```bash
   MY_REGION=us-east-1
   MY_REPO="shouvik/hello-world"

   aws ecr create-repository --repository-name $MY_REPO --region $MY_REGION
   ```

2. If you do not have a test container image to push to ECR, you can download a simple container for testing, e.g.[shodutta/hello-world](https://hub.docker.com/r/shodutta/hello-world)

   ```bash
   docker pull shodutta/hello-world
   ```

3. Get the image ID so we can tag it on the next step

   ```bash
   docker images | grep hello-world
   shodutta/hello-world    latest         15d53731c307        6 minutes ago       1.23MB
   ```

4. Tag the image with your registry uri

   ```bash
   MY_AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
   MY_REGION=us-east-1
   MY_REPO="shouvik/hello-world"
   MY_IMAGE_ID=$(docker images shodutta/hello-world --format "{{.ID}}")

   set| grep MY_

   docker tag $MY_IMAGE_ID $MY_AWS_ACCOUNT_ID.dkr.ecr.$MY_REGION.amazonaws.com/$MY_REPO
   ```

5. Your newly tagged image is now listed under `docker images`:
   
   ```bash
   docker images | grep hello-world
   664*********.dkr.ecr.us-east-1.amazonaws.com/shouvik/hello-world   latest              15d53731c307        11 minutes ago      1.23MB
   armsultan/hello-world                                             latest              15d53731c307        11 minutes ago      1.23MB
   ```

6. Push your tagged image to ECR

   ```bash
   # you can get copy the docker image name from the last step 
   docker push 664*********.dkr.ecr.us-east-1.amazonaws.com/shouvik/hello-world 
   ```

7. Check it is up there using the aws cli

   ```bash
   MY_REGION=us-east-1

   aws ecr describe-repositories --region $MY_REGION | grep hello-world

   # example output:
      "repositoryArn": "arn:aws:ecr:us-east-1:664*********:repository/shouvik/hello-world",
      "repositoryName": "shouvik/hello-world",
      "repositoryUri": "664*********.dkr.ecr.us-east-1.amazonaws.com/shouvik/hello-world",
   ```

## Uninstall and Delete your EKS cluster 

You can easily delete your EKS cluster using the `eksctl` tool

1. Delete the cluster and its associated nodes with the following command,
   replacing `$MY_EKS` with your cluster name. 

```bash
$MY_EKS=eks-shouvik-useast1
eksctl delete cluster $MY_EKS
```

This completes this Lab.

## References

- [TWpower's Tech Blog: Create, list and delete EC2 instance using AWS
  CLI](https://twpower.github.io/210-create-list-delete-ec2-instance-using-aws-cli-en)


### Authors
- Shouvik Dutta - Solutions Architect - Community and Alliances @ F5, Inc.

-------------
Navigate to ([Lab2](../lab2/readme.md) | [Main Menu](../LabGuide.md))
